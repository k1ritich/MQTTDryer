<!-- MAIN -->
<div class="table-data">
	<div class="order">
		<div class="">
			<h3>Recent Activities</h3>
		</div>
		<% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error!</strong> <%= error %>.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
        <% } else if ((typeof error !== 'undefined' && success)) { %>
			<div class="alert alert-success alert-dismissible fade show" role="alert">
                <strong>Successfully!</strong> <%= success %>.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
        <% } %>
		<table id="HistoryTable">
			<thead>
				<tr>
					<th class="text-center">#</th>
					<th class="text-center">Started By</th>
					<th class="text-center">Submited By</th>
					<th class="text-center">Drying Title</th>
					<th class="text-center">Item Quantity</th>
					<th class="text-center">Start Time</th>
					<th class="text-center">End Time</th>
					<th class="text-center">Duration</th>
					<th class="text-center">Status</th>
					<th class="text-center">Action</th>
				</tr>
			</thead>
			<tbody>
				<% if (onGoingTimers) { %>
				<tr>
					<td class="text-center">
						<p2>1.</p2>
						<p2><img src="<%= onGoingTimers.UserProfPic?  onGoingTimers.UserProfPic : '/Default.webp' %>"></p2>
					</td>
					<td class="text-center">
						<p2><%= onGoingTimers.UserName %></p2>
					</td>
					<td class="text-center">Not Yet Done</td>
					<td class="text-center"><%= onGoingTimers.DryingTitle %></td>
					<td class="text-center"><span><%= onGoingTimers.ItemQuantity %></span></td>
					<td class="text-center"><span><%= new Date(onGoingTimers.startTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'}) %></span></td>
					<td class="text-center"><span><%= onGoingTimers.endTime ? new Date(onGoingTimers.endTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'}) : 'N/A' %></span></td>
					<td class="text-center"><span id=></span></td>
					<% if (onGoingTimers.Status === 'Complete') { %>
					<td class="text-center"><span class="status completed">Complete</span></td>
					<% } else if (onGoingTimers.Status === 'On-going') {%>
					<td class="text-center"><span class="status pending">On-going</span></td>
					<% } else if (onGoingTimers.Status === 'OverTime') {%>
					<td class="text-center"><span class="status process">Overtime</span></td>
					<% }%> 
					<td class="text-center">
						
					</td>
				</tr>
				<% } %>
				
				<% MyHistory.forEach((history, index) => { %>
					<tr>
						<td class="text-center">
							<% if (onGoingTimers) { %>
								<p2><%= index + 2 %>.</p2>
							<% } else {  %>
							<p2><%= index + 1 %>.</p2>
							<% } %>
							<p2><img src="<%= history.UserProfPic?  history.UserProfPic : '/Default.webp' %>"></p2>
						</td>
						<td class="text-center">
							<p2><%= history.UserName %></p2>
						</td>
						<td class="text-center">
							<p2><%= history.SubmitBy %></p2>
						</td>
						<td class="text-center"><%= history.DryingTitle %></td>
						<td class="text-center"><span><%= history.ItemQuantity %></span></td>
						<td class="text-center"><span><%= new Date(history.startTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'})%></span></td>
						<td class="text-center"><span><%= new Date(history.stopTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'})%></span></td>
						<td class="text-center"><span id="Duration<%= index %>"></span></td>
						<% if (history.Status === 'Complete') { %>
						<td class="text-center"><span class="status completed">Complete</span></td>
						<% } else if (history.Status === 'On-going') {%>
						<td class="text-center"><span class="status pending">On-going</span></td>
						<% } else if (history.Status === 'OverTime') {%>
						<td class="text-center"><span class="status process">Overtime</span></td>
						<% }%> 
						<td class="text-center">
							<button style="background-color: #800000; margin-left: 30px; margin-right: 10px;" class="btn btn-danger" id="downloadPDFButton<%= history._id%>">Download</button>
						</td>
					</tr>
				<% }); %>
			</tbody>
		</table>
	</div>	
</div>

<!-- Data Table -->

<div class="table-data">
	<div class="order">
		<div class="">
			<h3>Activity Logs</h3>
		</div>
		<% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error!</strong> <%= error %>.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
        <% } else if ((typeof error !== 'undefined' && success)) { %>
			<div class="alert alert-success alert-dismissible fade show" role="alert">
                <strong>Successfully!</strong> <%= success %>.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
        <% } %>
		<table id="MyDataTable">
			<thead>
				<tr>
					<th class="text-center">#</th>
					<th class="text-center">Started By</th>
					<th class="text-center">Submited By</th>
					<th class="text-center">Drying Title</th>
					<th class="text-center">Item Quantity</th>
					<th class="text-center">Start Time</th>
					<th class="text-center">End Time</th>
					<th class="text-center">Duration</th>
					<th class="text-center">Status</th>
					<th class="text-center">Action</th>
				</tr>
			</thead>
			<tbody>
				<% if (onGoingTimers) { %>
				<tr>
					<td class="text-center">
						<p2>1.</p2>
						<p2><img src="<%= onGoingTimers.UserProfPic?  onGoingTimers.UserProfPic : '/Default.webp' %>"></p2>
					</td>
					<td class="text-center">
						<p2><%= onGoingTimers.UserName %></p2>
					</td>
					<td class="text-center">Not Yet Done</td>
					<td class="text-center"><%= onGoingTimers.DryingTitle %></td>
					<td class="text-center"><span><%= onGoingTimers.ItemQuantity %></span></td>
					<td class="text-center"><span><%= new Date(onGoingTimers.startTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'}) %></span></td>
					<td class="text-center"><span><%= onGoingTimers.endTime ? new Date(onGoingTimers.endTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'}) : 'N/A' %></span></td>
					<td class="text-center"><span id=></span></td>
					<% if (onGoingTimers.Status === 'Complete') { %>
					<td class="text-center"><span class="status completed">Complete</span></td>
					<% } else if (onGoingTimers.Status === 'On-going') {%>
					<td class="text-center"><span class="status pending">On-going</span></td>
					<% } else if (onGoingTimers.Status === 'OverTime') {%>
					<td class="text-center"><span class="status process">Overtime</span></td>
					<% }%> 
					<td class="text-center">
						<button style="background-color: #800000; margin-left: 30px; margin-right: 10px;" class="btn btn-danger" id="">Download</button>
					</td>
				</tr>
				<% } %>
				
				<% MyHistory.forEach((history, index) => { %>
					<tr>
						<td class="text-center">
							<% if (onGoingTimers) { %>
								<p2><%= index + 2 %>.</p2>
							<% } else {  %>
							<p2><%= index + 1 %>.</p2>
							<% } %>
							<p2><img src="<%= history.UserProfPic?  history.UserProfPic : '/Default.webp' %>"></p2>
						</td>
						<td class="text-center">
							<p2><%= history.UserName %></p2>
						</td>
						<td class="text-center">
							<p2><%= history.SubmitBy %></p2>
						</td>
						<td class="text-center"><%= history.DryingTitle %></td>
						<td class="text-center"><span><%= history.ItemQuantity %></span></td>
						<td class="text-center"><span><%= new Date(history.startTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'})%></span></td>
						<td class="text-center"><span><%= new Date(history.stopTime).toLocaleString('en-US', {timeZone: 'Asia/Manila'})%></span></td>
						<td class="text-center"><span id="Duration<%= index %>"></span></td>
						<% if (history.Status === 'Complete') { %>
						<td class="text-center"><span class="status completed">Complete</span></td>
						<% } else if (history.Status === 'On-going') {%>
						<td class="text-center"><span class="status pending">On-going</span></td>
						<% } else if (history.Status === 'OverTime') {%>
						<td class="text-center"><span class="status process">Overtime</span></td>
						<% }%> 
						<td class="text-center">
							<button style="background-color: #800000; margin-left: 30px; margin-right: 10px;" class="btn btn-danger" id="downloadPDFButton<%= history._id%>">Download</button>
						</td>
					</tr>
				<% }); %>
			</tbody>
		</table>
	</div>	
</div>

<!-- MAIN -->




<script>
    function Duration(startTime, endTime) {
        const durationInMillis = new Date(endTime) - new Date(startTime);
        const days = Math.floor(durationInMillis / (24 * 60 * 60 * 1000));
        const hours = Math.floor((durationInMillis % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const minutes = Math.floor((durationInMillis % (60 * 60 * 1000)) / (60 * 1000));

        return `${days} day/s ${hours} hour/s ${minutes} minute/s`;
    }

    $(document).ready(function () {
        // Loop through each history record and calculate the duration
        <% MyHistory.forEach((history, index) => { %>
            const startTime<%= index %> = '<%= history.startTime %>';
            const endTime<%= index %> = '<%= history.stopTime %>';
            const duration<%= index %> = Duration(startTime<%= index %>, endTime<%= index %>);
            $('#Duration<%= index %>').text(duration<%= index %>);
        <% }); %>
        // Initialize DataTable
        $('#HistoryTable').DataTable({
            responsive: true,
            "style": "bootstrap5"
        });
    });
</script>

<script>
	$('#MyDataTable').DataTable({
            responsive: true,
            "style": "bootstrap5"
    });
</script>


<script>
	document.addEventListener('DOMContentLoaded', () => {
	  <% MyHistory.forEach((history) => { %>
		document.getElementById('downloadPDFButton<%= history._id%>').addEventListener('click', async () => {
  try {
    const response = await fetch('/downloadSensorDataPDF?id=<%= history._id %>');

    if (!response.ok) {
      throw new Error(`Failed to fetch sensor data PDF: ${response.statusText}`);
    }

    const blob = await response.blob();
    const link = document.createElement('a');

    link.href = window.URL.createObjectURL(blob);
    link.download = 'sensorData.pdf';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch (error) {
    console.error('Error during PDF download:', error);
  }
});
	  <% }); %>
	});
  </script>
  
